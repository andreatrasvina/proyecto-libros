---
import "../styles/global.css";

const { exercises = [], currentBookSlug } = Astro.props;
---

<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Libro interactivo</title>
  </head>

  <body class="flex flex-col min-h-screen sidebar-open">
    <div class="fixed w-full h-[2px] rainbow-bar"></div>

    <div class="fixed top-4 right-4 z-50 flex items-center space-x-2">
      <button
        id="sidebar-toggle"
        class="flex items-center justify-center w-10 h-10 ml-1 bg-[var(--cards)] text-white rounded-md shadow-lg transition-transform transform hover:scale-110"
        aria-label="Toggle Sidebar"
      >
        <svg
          id="toggle-icon"
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6 text-[var(--titles)]"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </button>

      <a
        href="https://github.com/andreatrasvina/proyecto-libros"
        class="flex items-center justify-center w-10 h-10 bg-[var(--cards)] text-white rounded-md shadow-lg transition-transform transform hover:scale-110"
        aria-label="GitHub Repository"
        target="_blank"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          viewBox="0 0 24 24"
          fill="var(--titles)"
        >
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.809 1.305 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.118-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.046.138 3.003.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          ></path>
        </svg>
      </a>

      <button
        id="theme-toggle"
        class="flex items-center justify-center w-10 h-10 rounded-md shadow-lg transition-transform transform hover:scale-110 dark:bg-[var(--cards)] dark:text-white dark:focus:ring-gray-600"
        aria-label="Toggle dark mode"
      >
        <svg
          id="theme-icon"
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          viewBox="0 0 24 24"
          fill="var(--titles)"
        >
          <path
            class="moon-path"
            d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>

          <path
            class="sun-path hidden"
            d="M12 4V2m0 20v-2m8-8h2M2 12h2m15.364-7.364l1.414-1.414M4.222 19.778l1.414-1.414m0-12.728L4.222 4.222m14.142 14.142l1.414 1.414M12 6a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"></path>
        </svg>
      </button>
    </div>

    <div class="flex flex-1 overflow-hidden">
      <aside
        id="sidebar"
        class="flex flex-col bg-clip-border rounded-xl bg-[var(--titlesnt)] text-gray-700 w-78 p-4 fixed top-2 h-[calc(100vh-16px)] transition-all duration-300 ease-in-out z-40"
      >
        <div class="mb-2 p-4">
          <h5
            class="block antialiased tracking-normal font-sans text-xl font-semibold leading-snug text-[var(--titles)]"
          >
            Contenido
          </h5>
        </div>
        <nav
          class="flex flex-col gap-1 p-2 font-sans lato-regular text-gray-700 overflow-y-auto"
        >
          <a
            href={`/books/${currentBookSlug}`}
            class={`text-[var(--sidebarText)] flex items-center w-full p-3 rounded-lg text-start leading-tight transition-all hover:bg-[var(--hoverSidebar)] hover:bg-opacity-80 focus:bg-[var(--hoverSidebar)] focus:bg-opacity-80 active:bg-[var(--hoverSidebar)] active:bg-opacity-80 hover:text-[var(--textoHover)] focus:text-[var(--textoHover)] active:text-[var(--textoHover)] outline-none
  ${Astro.url.pathname === `/books/${currentBookSlug}/` ? "bg-[var(--hoverSidebar)] bg-opacity-80 !text-[var(--textoHover)]" : ""}`}
          >
            <div class="grid place-items-center mr-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 640 640"
                fill="currentColor"
                class="h-5 w-5"
              >
                <path
                  d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 304C288 312.8 280.8 320 272 320C263.2 320 256 312.8 256 304L256 128C256 110.3 241.7 96 224 96C206.3 96 192 110.3 192 128L192 400C192 401.5 192 403.1 192.1 404.6L131.6 347C115.6 331.8 90.3 332.4 75 348.4C59.7 364.4 60.4 389.7 76.4 405L188.8 512C231.9 553.1 289.2 576 348.8 576L368 576C465.2 576 544 497.2 544 400L544 192C544 174.3 529.7 160 512 160C494.3 160 480 174.3 480 192L480 304C480 312.8 472.8 320 464 320C455.2 320 448 312.8 448 304L448 128C448 110.3 433.7 96 416 96C398.3 96 384 110.3 384 128L384 304C384 312.8 376.8 320 368 320C359.2 320 352 312.8 352 304L352 96z"
                ></path>
              </svg>
            </div>
            Introduccion
          </a>

          {
            exercises.map((ex: { slug: string; data: { title: unknown } }) => (
              <a
                href={`/books/${currentBookSlug}/${ex.slug.split("/").pop()}`}
                class={`text-[var(--sidebarText)] flex items-center w-full p-3 rounded-lg text-start leading-tight transition-all hover:bg-[var(--hoverSidebar)] hover:bg-opacity-80 focus:bg-[var(--hoverSidebar)] focus:bg-opacity-80 active:bg-[var(--hoverSidebar)] active:bg-opacity-80 hover:text-[var(--textoHover)] focus:text-[var(--textoHover)] active:text-[var(--textoHover)] outline-none
  ${Astro.url.pathname.includes(ex.slug.split("/").pop() as string) ? "bg-[var(--hoverSidebar)] bg-opacity-80 !text-[var(--textoHover)]" : ""}`}
              >
                <div class="grid place-items-center mr-4">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    class="h-5 w-5"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4.5 6.75A2.25 2.25 0 016.75 4.5h10.5A2.25 2.25 0 0119.5 6.75v10.5a2.25 2.25 0 01-2.25 2.25H6.75a2.25 2.25 0 01-2.25-2.25V6.75zM6 8.25h12v1.5H6v-1.5zm0 3h12v1.5H6v-1.5zm0 3h8.25v1.5H6v-1.5z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                {ex.data.title}
              </a>
            ))
          }

          <a
            href="/books"
            class="text-[var(--sidebarText)] flex items-center w-full p-3 rounded-lg text-start leading-tight transition-all hover:bg-[var(--hoverSidebar)] hover:bg-opacity-80 focus:bg-[var(--hoverSidebar)] focus:bg-opacity-80 active:bg-[var(--hoverSidebar)] active:bg-opacity-80 hover:text-[var(--textoHover)] focus:text-[var(--textoHover)] active:text-[var(--textoHover)] outline-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-4"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
            <span>Volver</span>
          </a>
        </nav>

        <hr class="border-0 h-[2px] mt-3 bg-[var(--rayas)]" />

        <div
          class="mt-8 flex items-center gap-2 border border-green-500 rounded-md p-4 text-[#206f47] bg-[#dbede6] max-w-md"
        >
          <span
            >☝️ Para acceder a los ejercicios selecciona una opción de arriba</span
          >
        </div>
      </aside>

      <!-- Aqui va el spacer -->
      <div
        id="sidebar-spacer"
        class="w-[330px] transition-all duration-300 ease-in-out flex-shrink-0"
      >
      </div>

      <main class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto p-8 prose prose-invert mt-10">
          <slot name="introduction" />
          <slot name="main" />
        </div>
      </main>
    </div>
  </body>
</html>

<script>
  const themeToggle = document.getElementById("theme-toggle");
  const body = document.body;

  // Elementos para alternar el icono
  const sunPath = document.querySelector(".sun-path");
  const moonPath = document.querySelector(".moon-path");

  // Función para actualizar los iconos
  const updateIcon = () => {
    // Si el body contiene la clase dark-mode mostrar el sol
    if (body.classList.contains("dark-mode")) {
      sunPath.classList.remove("hidden");
      moonPath.classList.add("hidden");
    } else {
      // si no, pues muestra la luna
      sunPath.classList.add("hidden");
      moonPath.classList.remove("hidden");
    }
  };

  //Preferencia por localstorage
  const currentTheme = localStorage.getItem("theme");
  if (currentTheme) {
    body.classList.add(currentTheme);
    // Llamar a updateIcon para establecer el icono correcto al cargar
    updateIcon();
  } else {
    // Asegurar que el icono inicial (luna) es correcto si no hay tema guardado
    updateIcon();
  }

  // Agrega el "listener" para el clic en el botón
  themeToggle.addEventListener("click", (e) => {
    e.preventDefault();
    body.classList.toggle("dark-mode");

    if (body.classList.contains("dark-mode")) {
      localStorage.setItem("theme", "dark-mode");
    } else {
      localStorage.removeItem("theme");
    }

    updateIcon();
  });

  // Script para el Sidebar Abatible
  const sidebarToggle = document.getElementById("sidebar-toggle");
  const sidebar = document.getElementById("sidebar");
  const sidebarSpacer = document.getElementById("sidebar-spacer");
  const toggleIcon = document.getElementById("toggle-icon");

  // Definir el ancho del sidebar para las transiciones
  const SIDEBAR_WIDTH = "330px";
  const COLLAPSED_MARGIN = "0px";

  // Clase de utilidad para ocultar/mostrar elementos
  // vamos a usar esta en el CSS para un mejor manejo de la transición del ancho del espaciador y la posición del sidebar fijo.

  // Establecer el estado inicial del sidebar
  let isSidebarOpen = true;

  const toggleSidebar = () => {
    isSidebarOpen = !isSidebarOpen;

    // Toggle class en el body para aplicar estilos CSS
    body.classList.toggle("sidebar-collapsed");

    // Actualizar el estado del espaciador
    sidebarSpacer.style.width = isSidebarOpen
      ? SIDEBAR_WIDTH
      : COLLAPSED_MARGIN;

    // Esta parte del codigo si me la robe de internet
    // Abierto: flecha apuntando a la izquierda (ocultar)
    // Cerrado: flecha apuntando a la derecha (mostrar)
    if (isSidebarOpen) {
      toggleIcon.innerHTML = `<path d="M15 18l-6-6 6-6"></path>`;
      // Asegurarse de que el sidebar está visible
      sidebar.style.left = "0";
    } else {
      toggleIcon.innerHTML = `<path d="M9 18l6-6-6-6"></path>`;
      // Mover el sidebar fuera de la vista
      sidebar.style.left = `-${SIDEBAR_WIDTH}`;
    }
  };

  // Inicializar el ancho del espaciador en la carga de la página
  sidebarSpacer.style.width = SIDEBAR_WIDTH;

  // Listener para el botón de alternancia
  sidebarToggle.addEventListener("click", toggleSidebar);
</script>

<style>
  .centrar {
    margin: 0 auto;
  }

  /* Animación Rainbow (existente) */
  @keyframes rainbow {
    0% {
      background-position: 0% 50%;
    }
    100% {
      background-position: 200% 50%;
    }
  }

  .rainbow-bar {
    background: linear-gradient(
      to right,
      red,
      orange,
      yellow,
      green,
      blue,
      indigo,
      violet
    );
    background-size: 200% 200%;
    animation: rainbow 4s linear infinite;
  }

  /* Estilos del Sidebar */

  /* Sidebar: Usamos fixed y left: 0 para la posición inicial. */
  #sidebar {
    width: 312px;
    left: 0;
  }

  /* Es importante que el espaciador refleje el ancho real de la barra lateral */
  #sidebar-spacer {
    width: 312px;
  }

  /* Ajuste para el botón de alternancia para que no se mueva con el scroll */
  #sidebar-toggle {
    position: fixed;
    left: 312px; /* esta es la posicion que tendra al final del sidebar jeje */
    transition: left 0.3s ease-in-out;
    z-index: 50;
    margin-bottom: 14px;
  }

  /* Estado cuando el sidebar está colapsado en el body */
  .sidebar-collapsed #sidebar {
    left: -312px; /* Mueve el sidebar completamente fuera de la pantalla */
  }

  /* Mueve el botón de alternancia al borde izquierdo cuando está colapsado */
  .sidebar-collapsed #sidebar-toggle {
    left: 0.5rem;
  }

  /* Esto ya se maneja con js, pero por si acaso ponemos la referencia */
  .sidebar-collapsed #sidebar-spacer {
    width: 0px !important; /*El espaciador no ocupa espacio */
  }
</style>
