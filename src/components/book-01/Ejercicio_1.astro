<div>
  <h3 class="text-[var(--titlesMd)] text-3xl lato-bold">
    Ejercicio interactivo
  </h3>
  <hr class="border-[var(--titlesMd)]" />
  <div
    class="p-4 my-6 border border-[var(--borderEjercicio)] rounded-md shadow-[0_8px_30px_var(--shadowEjercicio)] bg-[var(--cardEjercicio)]"
  >
    <h1 class="font-semibold text-lg text-[var(--titles)]">
      Gradiente hidráulico
    </h1>

    <label for="humedad" class="text-[var(--titles)] mt-2">
      <span class="lato-bold">Cómo funciona: </span> Lorem ipsum dolor sit amet consectetur
      adipisicing elit. Doloremque esse cumque vero tempora dolores ratione, quo
      possimus itaque commodi ducimus consequuntur perferendis, accusantium pariatur
      nulla adipisci a assumenda error nesciunt?
    </label>

    <!-- aqui va el canvas -->
    <div class="canvas mt-10 mb-14">
      <canvas
        id="myCanvas"
        width="800"
        height="400"
        style="border:1px solid var(--borderEjercicio); margin: 0 auto;"
        class="rounded"
      >
      </canvas>
    </div>

    <label class="switch-container flex items-center space-x-2">
      <div class="switch">
        <input type="checkbox" id="manual" />
        <span class="slider-toggle text-[var(--titles)]"></span>
      </div>
      <h1 class="lato-regular text-sm mt-3">Datos manuales</h1>
    </label>

    <div class="controls">
      <div class="section-card">
        <h3>Sección A</h3>

        <!-- range de K -->
        <label for="kA">K (Conductividad)</label>
        <input type="range" id="kA" min="1" max="50" value="25" />
        <span class="removeSpan" id="kAVal">25</span><span class="removeSpan"
          >m/d</span
        >

        <!-- range del area -->
        <label for="aA">A (Área)</label>
        <input type="range" id="aA" min="1" max="100" value="30" />
        <span class="removeSpan" id="aAVal">30</span>
      </div>

      <div class="section-card">
        <h3>Sección B</h3>
        <label for="kB">K (Conductividad)</label>
        <input type="range" id="kB" min="1" max="50" value="25" />
        <span class="removeSpan" id="kBVal">25</span><span class="removeSpan"
          >m/d</span
        >

        <!-- range del area tubo 2 -->
        <label for="aB">A (Área)</label>
        <input type="range" id="aB" min="1" max="100" value="30" />
        <span class="removeSpan" id="aBVal">30</span>
      </div>

      <div class="section-card">
        <h3>Sección C</h3>
        <label for="kC">K (Conductividad)</label>
        <input type="range" id="kC" min="1" max="50" value="25" />
        <span class="removeSpan" id="kCVal">25</span><span class="removeSpan"
          >m/d</span
        >

        <!-- range del area tubo 3 -->
        <label for="aC">A (Área)</label>
        <input type="range" id="aC" min="1" max="100" value="30" />
        <span class="removeSpan" id="aCVal">30</span>
      </div>

      <div class="section-card">
        <h3>Sección Otra</h3>
        <label for="ejemplo">Q (Caudal): </label>
        <input type="range" id="ejemplo" min="1" max="100" value="30" />
        <span class="removeSpan" id="ejemploVal">30</span>
      </div>
    </div>

    <div class="mt-6">
      <button
        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-colors duration-300 ease-in-out"
        >Iniciar</button
      >

      <button
        class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-colors duration-300 ease-in-out"
      >
        Reiniciar
      </button>
    </div>
  </div>
</div>

<script>
  //esto es para los numeritos del span, se actualizan cuando se mueve el range
  document.querySelectorAll("input[type=range]").forEach((slider) => {
    const span = document.getElementById(slider.id + "Val");
    if (span) {
      slider.addEventListener("input", () => {
        span.textContent = slider.value;
      });
    }
  });

  //convertir el tipo slider a manual equis de
  document.getElementById("manual").addEventListener("change", (e) => {
    const isManual = e.target.checked;

    const type = e.target.checked ? "number" : "range";

    //seccion a
    document.getElementById("kA").type = type;
    document.getElementById("aA").type = type;

    //seccion b
    document.getElementById("kB").type = type;
    document.getElementById("aB").type = type;

    //seccion c
    document.getElementById("kC").type = type;
    document.getElementById("aC").type = type;

    //seccion ejemplo
    document.getElementById("ejemplo").type = type;

    document.querySelectorAll(".removeSpan").forEach((span) => {
      span.style.display = isManual ? "none" : "inline";
    });
  });

  // funcionn para dibujar los piezometros
  function drawPiezometro(ctx, x, y, width, height, hAgua) {
    //agua dentro del tubo
    ctx.fillStyle = "#4ad6ff";
    ctx.fillRect(x, y + height - hAgua, width, hAgua);

    //tubo del piezometro
    ctx.strokeStyle = borderColor;
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, width, height);
  }

  function drawTube(ctx, x, centroY, w, h) {
    ctx.fillStyle = "#a4d8f2";
    ctx.strokeStyle = "#555";
    ctx.lineWidth = 2;

    //calcular el punto superior para mantener el centro fijo jeje
    const y = centroY - h / 2;

    ctx.fillRect(x, y, w, h);
    ctx.strokeRect(x, y, w, h);
  }

  function drawGradienteHidraulico(ctx, piezometros) {
    ctx.beginPath();

    piezometros.forEach((p, i) => {
      const xCentro = p.x + p.w / 2;
      const yAgua = p.y + p.h - p.hAgua;
      if (i === 0) ctx.moveTo(xCentro, yAgua);
      else ctx.lineTo(xCentro, yAgua);
    });

    ctx.strokeStyle = "brown";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  const canvas = document.getElementById("myCanvas");
  const ctx = canvas.getContext("2d");

  //Obtener el valor real de la variable CSS
  const styles = getComputedStyle(document.documentElement);
  const borderColor = styles.getPropertyValue("--rayaTubo").trim();

  //Tubo 1
  const areaTubo1 = document.getElementById("aA");
  console.log("Valor del tubo:", areaTubo1.value);

  //Tubo 2
  const areaTubo2 = document.getElementById("aB");
  console.log("Valor del tubo:", areaTubo2.value);

  //Tubo 3
  const areaTubo3 = document.getElementById("aC");
  console.log("Valor del tubo:", areaTubo3.value);

  //Empezamos con la logica de la ley de darcy

  //1. Dejaremos fijos los metros de L, seran 200
  const L = 200;
  const altura_piezometro_total = 200;
  const h_inicial = 150; //Altura del primer piezometro
  const altura_base_tubo = 335;

  //Esta funcion obtiene los valores de los inputs (ya sean range o number)
  function getValorInput(id) {
    const elemento = document.getElementById(id);
    return parseFloat(elemento.value);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const kA = getValorInput("kA");
    const aA = getValorInput("aA");
    const kB = getValorInput("kB");
    const aB = getValorInput("aB");
    const kC = getValorInput("kC");
    const aC = getValorInput("aC");
    const Q = getValorInput("ejemplo");

    // dibuja los tubos (usando los valores de Área directamente como altura visual)
    drawTube(ctx, 100, 320, 200, aA);
    drawTube(ctx, 300, 320, 200, aB);
    drawTube(ctx, 500, 320, 200, aC);

    // 2. CALCULO DEL GRADIENTE (i) Y PERDIDA DE CARGAa (Delta de h), la cual sera fija porque el largo de los tubos sera de 200
    // Fórmula: i = Q / (K * A) y Delta h = i * L

    //Seccion A
    const denominadorA = kA * aA;
    const iA = Q / denominadorA; // i = Q / (K * A)
    const deltaHA = iA * L; // Delta h = i * L

    //seccionn B
    const denominadorB = kB * aB;
    const iB = Q / denominadorB;
    const deltaHB = iB * L;

    //Seccion C
    const denominadorC = kC * aC;
    const iC = Q / denominadorC;
    const deltaHC = iC * L;

    //3 CÁLCULO DE LAS CARGAS PIEZOMÉTRICAS (h)
    // Carga inicial (P1). Asume que 'h_inicial' ya está definida globalmente
    let h1 = h_inicial;

    // Carga en la unión A-B (P2)
    let h2 = h1 - deltaHA;

    // Carga en la unión B-C (P3)
    let h3 = h2 - deltaHB;

    // Carga final (P4)
    let h4 = h3 - deltaHC;

    // 4b. APLICACIÓN DEL CONTROL DE LÍMITES (Define safeH1, safeH2, etc.)
    // Asegurarse de que las cargas no sean < 0 ni > altura_piezometro_total

    // altura_piezometro_total = 200;
    // h_inicial = 150;
    // altura_base_tubo = 335;

    // Esto es necesario para la coordenada 'y' en el array piezometros
    const Y_SUPERIOR = altura_base_tubo - altura_piezometro_total;
    const safeH1 = Math.min(Math.max(h1, 0), altura_piezometro_total);
    const safeH2 = Math.min(Math.max(h2, 0), altura_piezometro_total);
    const safeH3 = Math.min(Math.max(h3, 0), altura_piezometro_total);
    const safeH4 = Math.min(Math.max(h4, 0), altura_piezometro_total);

    //dibuja los piezometros
    const piezometros = [
      // Usamos Y_SUPERIOR (calculada arriba) y las cargas dinámicas (safeHX)
      {
        x: 120,
        y: Y_SUPERIOR,
        w: 20,
        h: altura_piezometro_total,
        hAgua: safeH1,
      },
      {
        x: 290,
        y: Y_SUPERIOR,
        w: 20,
        h: altura_piezometro_total,
        hAgua: safeH2,
      },
      {
        x: 490,
        y: Y_SUPERIOR,
        w: 20,
        h: altura_piezometro_total,
        hAgua: safeH3,
      },
      {
        x: 660,
        y: Y_SUPERIOR,
        w: 20,
        h: altura_piezometro_total,
        hAgua: safeH4,
      },
    ];

    piezometros.forEach((p) =>
      drawPiezometro(ctx, p.x, p.y, p.w, p.h, p.hAgua),
    );

    //dibuja la linea que conecta los niveles de agua jeje
    drawGradienteHidraulico(ctx, piezometros);
  }

  draw();

  document.getElementById("kA").addEventListener("input", draw);
  document.getElementById("aA").addEventListener("input", draw);
  document.getElementById("kB").addEventListener("input", draw);
  document.getElementById("aB").addEventListener("input", draw);
  document.getElementById("kC").addEventListener("input", draw);
  document.getElementById("aC").addEventListener("input", draw);
  document.getElementById("ejemplo").addEventListener("input", draw); // Q
  areaTubo1.addEventListener("input", draw);
  areaTubo2.addEventListener("input", draw);
  areaTubo3.addEventListener("input", draw);
</script>

<style>
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .section-card {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.178);
  }

  .section-card h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--titles);
  }

  .section-card label {
    display: block;
    margin-top: 8px;
    font-size: 13px;
    color: var(--textoCardCanvas);
  }

  .section-card input[type="range"] {
    width: 100%;
    margin-top: 4px;
  }

  .section-card input[type="number"] {
    width: 100%;
    margin-top: 4px;
    outline: none;
    color: var(--textoHover);
    background-color: var(--hoverSidebar);
    padding-left: 12px;
    border-radius: 5px;
  }

  .section-card span {
    font-size: 14px;
    font-weight: 600;
    color: var(--textoCardCanvas);
    margin-left: 8px;
  }

  .section-card:hover {
    transform: scale(0.99);
    /* box-shadow: 0 10px 25px rgba(0, 0, 0, 0.55); */
    border-color: rgba(0, 191, 255, 0.4);
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider-toggle {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    transition: 0.4s;
    border-radius: 34px;
  }

  .slider-toggle:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  .switch input:checked + .slider-toggle {
    background-color: #00bfff;
  }

  .switch input:checked + .slider-toggle:before {
    transform: translateX(18px);
  }
</style>
