---
//distance ‚àÜL
const minDistance = 10;
const maxDistance = 100;
const initDistance = 50;

//flow rate Q
const minQ = 1;
const maxQ = 10;
const initQ = 5;

//conductivity K
const minK = 3;
const maxK = 10;
const initK = 5;

//area A
const minA = 1;
const maxA = 10;
const initA = 5;
---

<div class="layout">
  <!-- Panel Gr√°fica -->
  <div
    class="visual border border-[var(--borderMario)] bg-[var(--cardMario)] rounded-md shadow-[0_8px_30px_var(--shadowMario)]"
  >
    <h2>Gr√°fica</h2>

    <div class="graph">
      <div class="height-line bg-[var(--color-primary)]"></div>

      <div class="container">
        <div class="pms">
          <div class="piezometer" id="pm-1">
            <div class="water"><h3>h‚ÇÅ</h3></div>
            <!-- l√≠nea punteada para h1 -->
            <div class="dotted-line" id="line-h1"></div>
          </div>
          <div class="piezometer" id="pm-2">
            <div class="water"><h3>h‚ÇÇ</h3></div>
            <!-- l√≠nea punteada para h2 -->
            <div class="dotted-line" id="line-h2"></div>
          </div>
        </div>

        <div class="cylinder">
          <div class="circle front"></div>
          <div class="body"></div>
          <div class="circle back"></div>
        </div>

        <div class="delta-container">
          <div class="linea"></div>
          <span class="delta-text">‚àÜL</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel derecho -->
  <div class="right-column">
    <!-- Panel datos-->
    <div
      class="data border border-[var(--borderMario)] bg-[var(--cardMario)] rounded-md shadow-[0_8px_30px_var(--shadowMario)]"
    >
      <h2>Datos</h2>
      <div class="data-grid">
        <div>
          <h3 class="data-label">h‚ÇÅ:</h3><h3 class="data-value" id="data-1">
          </h3>
        </div>
        <div>
          <h3 class="data-label">h‚ÇÇ:</h3><h3 class="data-value" id="data-2">
          </h3>
        </div>
        <div>
          <h3 class="data-label">‚àÜL:</h3><h3 class="data-value" id="data-3">
          </h3>
        </div>
        <div>
          <h3 class="data-label">‚àÜh/‚àÜL:</h3><h3 class="data-value" id="data-4">
          </h3>
        </div>
        <div>
          <h3 class="data-label">Q:</h3><h3 class="data-value" id="data-5"></h3>
        </div>
        <div>
          <h3 class="data-label">K:</h3><h3 class="data-value" id="data-6"></h3>
        </div>
        <div>
          <h3 class="data-label">A:</h3><h3 class="data-value" id="data-7"></h3>
        </div>
      </div>
    </div>

    <!-- Panel controles -->
      <div class="panel border border-[var(--borderMario)] bg-[var(--cardMario)] rounded-md shadow-[0_8px_30px_var(--shadowMario)]">
        <h2>Controles</h2>
        <label>Tipo de input</label>
        <input type="checkbox" id="input-type" value="true"/>
        <br><br>
        <label>Distancia entre piez√≥metros</label>
        <input id="range-distance" type="range" min={minDistance} max={maxDistance} value={initDistance} />
        <input id="number-distance" type="number" min={minDistance} max={maxDistance} value={initDistance} />
        <br><br>
        <label>Ratio de flujo</label>
        <input id="range-Q" type="range" min={minQ} max={maxQ} value={initQ} />
        <input id="number-Q" type="number" min={minQ} max={maxQ} value={initQ} />
        <br><br>
        <label>Conductividad</label>
        <input id="range-K" type="range" min={minK} max={maxK} value={initK} />
        <input id="number-K" type="number" min={minK} max={maxK} value={initK} />
        <br><br>
        <label>Area</label>
        <input id="range-A" type="range" min={minA} max={maxA} value={initA} />
        <input id="number-A" type="number" min={minA} max={maxA} value={initA} />
      </div>
    </div>
  </div>
</div>

<script>
  //elements for distance (‚àÜL) control
  const type = document.getElementById("input-type") as HTMLInputElement;
  const rangeDistanceIn = document.getElementById("range-distance") as HTMLInputElement;
  const numberDistanceIn = document.getElementById("number-distance") as HTMLInputElement;

  //elements for flow rate (Q) control
  const rangeQIn = document.getElementById("range-Q") as HTMLInputElement;
  const numberQIn = document.getElementById("number-Q") as HTMLInputElement;

  //elements for conductivity (K) control
  const rangeKIn = document.getElementById("range-K") as HTMLInputElement;
  const numberKIn = document.getElementById("number-K") as HTMLInputElement;

  //elements for area (A) control
  const rangeAIn = document.getElementById("range-A") as HTMLInputElement;
  const numberAIn = document.getElementById("number-A") as HTMLInputElement;

  //elementes for piezometer and water level
  const pm1 = document.getElementById("pm-1") as HTMLDivElement;
  const pm2 = document.getElementById("pm-2") as HTMLDivElement;
  const water1 = document.querySelector("#pm-1 .water") as HTMLDivElement;
  const water2 = document.querySelector("#pm-2 .water") as HTMLDivElement;

  //elements for ‚àÜL visualization
  const deltaContainer = document.querySelector(".delta-container") as HTMLDivElement;
  const linea = document.querySelector(".linea") as HTMLDivElement;
  const deltaText = document.querySelector(".delta-text") as HTMLDivElement;

  //data values
  const data1 = document.getElementById("data-1") as HTMLLabelElement;
  const data2 = document.getElementById("data-2") as HTMLLabelElement;
  const data3 = document.getElementById("data-3") as HTMLLabelElement;
  const data4 = document.getElementById("data-4") as HTMLLabelElement;
  const data5 = document.getElementById("data-5") as HTMLLabelElement;
  const data6 = document.getElementById("data-6") as HTMLLabelElement;
  const data7 = document.getElementById("data-7") as HTMLLabelElement;
  const data8 = document.getElementById("data-8") as HTMLLabelElement;

  // üîπ L√≠neas punteadas
  const lineH1 = document.getElementById("line-h1") as HTMLDivElement;
  const lineH2 = document.getElementById("line-h2") as HTMLDivElement;
  const leftLine = document.querySelector(".height-line") as HTMLDivElement;
  const graph = document.querySelector(".graph") as HTMLDivElement;

  const water1Height = water1.offsetHeight;

  //‚àÜL
  let distance = 50;
  let flowRate = 2;
  let conductivity = 0.5;
  let area = 4;

  function actualizarInputType() {
    if (type.checked) {
      distance = parseInt(rangeDistanceIn.value);
      flowRate = parseInt(rangeQIn.value);
      conductivity = parseFloat(rangeKIn.value);
      area = parseFloat(rangeAIn.value);

      numberDistanceIn.style.display = "none";
      numberQIn.style.display = "none";
      numberKIn.style.display = "none";
      numberAIn.style.display = "none";

      rangeDistanceIn.style.display = "flex";
      rangeQIn.style.display = "flex";
      rangeKIn.style.display = "flex";
      rangeAIn.style.display = "flex";
    } else {
      distance = parseInt(numberDistanceIn.value);
      flowRate = parseInt(numberQIn.value);
      conductivity = parseFloat(numberKIn.value);
      area = parseFloat(numberAIn.value);

      numberDistanceIn.style.display = "flex";
      numberQIn.style.display = "flex";
      numberKIn.style.display = "flex";
      numberAIn.style.display = "flex";

      rangeDistanceIn.style.display = "none";
      rangeQIn.style.display = "none";
      rangeKIn.style.display = "none";
      rangeAIn.style.display = "none";
    }
  }

  function actualizarEstado() {
    // Movimiento horizontal del pm-2
    pm2.style.marginLeft = distance + "px";

    // h2 = h1 - ((Q * ‚àÜL) / (K * A))
    let water2Height =
      water1Height - (flowRate * distance) / (conductivity * area);
    if (water2Height <= 0) water2Height = 0;

    // Ajuste de altura de agua
    water2.style.height = water2Height + "px";

    // Actualizaci√≥n de datos
    data1.textContent = water1Height.toFixed(2) + "m";
    data2.textContent = water2Height.toFixed(2) + "m";
    data3.textContent = distance.toFixed(2) + "m";
    let slope = ((water2Height - water1Height) / distance).toFixed(2);
    data4.textContent = slope + "m";
    data5.textContent = flowRate.toFixed(2) + "m¬≥";
    data6.textContent = conductivity.toFixed(2) + "m/d√≠a";
    data7.textContent = area.toFixed(2) + "m¬≤";

    // === L√çNEAS PUNTEADAS ===
    const graphRect = graph.getBoundingClientRect();
    const leftLineRect = leftLine.getBoundingClientRect();
    const pm1Rect = pm1.getBoundingClientRect();

    // üîß Calcular ancho en coordenadas del gr√°fico
    const offsetLeftGraph = graphRect.left;
    const offsetLeftLine = leftLineRect.right - offsetLeftGraph;
    const offsetPm1 = pm1Rect.left - offsetLeftGraph;

    const width1 = Math.max(0, offsetPm1 - offsetLeftLine);
    // width2 = distancia de separacion del primer pz + distance + gap entre los pms y width de los pms
    const width2 = width1 + distance + 55;

    lineH1.style.width = width1 + "px";
    lineH2.style.width = width2 + "px";

    // Mover las l√≠neas hacia la izquierda dentro de su contenedor
    lineH1.style.marginLeft = -width1 + "px"
    lineH2.style.marginLeft = -width2 + "px"
  }

  function actualizarLinea() {
    const rect1 = pm1.getBoundingClientRect();
    const rect2 = pm2.getBoundingClientRect();
    const parentRect = deltaContainer.getBoundingClientRect();

    const center1 = rect1.left + rect1.width / 2;
    const center2 = rect2.left + rect2.width / 2;

    const left = Math.min(center1, center2) - parentRect.left;
    // 55 = gap + pms-width
    // 55 = 25 + 30
    const width = distance + 55;

    linea.style.left = left + "px";
    linea.style.width = width + "px";
    const offset = deltaText.offsetWidth / 2;
    deltaText.style.left = left + width / 2 - offset + "px";
  }

  function actualizarTodo() {
    actualizarInputType();
    actualizarEstado();
    actualizarLinea();
  }

  rangeDistanceIn.addEventListener("input", actualizarTodo);
  numberDistanceIn.addEventListener("input", actualizarTodo);
  rangeQIn.addEventListener("input", actualizarTodo);
  numberQIn.addEventListener("input", actualizarTodo);
  rangeKIn.addEventListener("input", actualizarTodo);
  numberKIn.addEventListener("input", actualizarTodo);
  rangeAIn.addEventListener("input", actualizarTodo);
  numberAIn.addEventListener("input", actualizarTodo);
  type.addEventListener("input", actualizarTodo);

  actualizarTodo() 
</script>

<style>
  /* === LAYOUT PRINCIPAL === */
  .layout {
    display: flex;
    gap: 20px;
    padding: 20px 0;
    align-items: flex-start;
  }

  .data-grid div {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 15px;
    border-bottom: 1px solid var(--borderMario);
  }

  .data-label {
    font-weight: 500;
    font-size: 1rem;
    margin: 0;
  }

  .data-value {
    font-weight: 800;
    font-size: 0.95rem;
    margin: 0;
  }

  .visual,
  .right-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  .visual {
    border-radius: 10px;
    padding: 20px;
    border: 1px solid var(--borderMario);
    background: var(--cardMario);
    box-shadow: 0 8px 30px var(--shadowMario);
  }

  .right-column {
    gap: 20px;
  }

  .visual h2,
  .data h2 {
    margin-top: 0;
    margin-bottom: 15px;
    text-align: center;
  }

  /* === GR√ÅFICA === */
  .graph {
    display: flex;
    flex-direction: row;
    height: auto;
    min-height: 50vh;
    position: relative;
  }

  .height-line {
    width: 4px;
    margin-right: 20px;
    background: var(--color-primary);
  }

  /* Contenedor general de la gr√°fica */
  .container {
    display: flex;
    flex: 1;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    margin-bottom: 2vh;
  }

  /* Piez√≥metros */
  .pms {
    display: flex;
    gap: 25px;
    z-index: 10;
    min-width: 200px;
  }

  .piezometer {
    position: relative; /* necesario para las dotted-lines absolutas */
    display: flex;
    flex-direction: column-reverse;
    width: 30px;
    height: 200px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgb(0, 0, 0);
    border-bottom: 0;
    border-top: 0;
    transition: margin-left 0.5s ease;
  }

  .piezometer#pm-1 > .water {
    height: 70%;
  }

  .piezometer#pm-2 > .water {
    height: 50%;
  }

  /* Agua dentro de piez√≥metro */
  .water {
    width: 100%;
    background: rgba(74, 214, 255);
    transition: height 0.5s ease;
  }

  .water h3 {
    margin-top: -1em;
    margin-left: 1.8em;
  }

  .dotted-line {
    left: 0;
    width: 100%;
    border-top: 2px dashed black;
    margin-bottom: -2px;
    opacity: 0.7;
    pointer-events: none;
    transition: 0.5s ease;
  }

  body.dark-mode .dotted-line {
    border-top: 2px dashed white;
  }

  /* === L√≠nea ‚àÜL === */
  .delta-container {
    position: relative;
    width: 100%;
    height: 20px;
    margin-top: -30px;
  }

  .linea {
    position: absolute;
    top: 50%;
    height: 2px;
    background: black !important;
    color: black !important;
    transition: width 0.5s ease;
  }

  .linea::before,
  .linea::after {
    content: "";
    position: absolute;
    top: -8px;
    width: 2px;
    height: 18px;
    background: black !important;
  }

  .linea::before {
    left: 0;
  }

  .linea::after {
    right: 0;
  }

  .delta-text {
    position: absolute;
    top: -12px;
    font-weight: bold;
    padding: 0 4px;
    color: black !important;
    transition: all 0.5s ease;
  }

  /* === Cilindro === */
  .cylinder {
    margin-top: -20px;
    display: flex;
    align-items: center;
    z-index: 0;
  }

  .circle {
    width: 30px;
    height: 50px;
    background: rgba(190, 247, 255);
    border: 1px solid black;
    border-radius: 50%;
    position: relative;
  }

  .circle.front {
    z-index: 3;
  }

  .body {
    width: 280px;
    height: 50px;
    background: rgba(190, 247, 255);
    border-top: 1px solid black;
    border-bottom: 1px solid black;
    position: relative;
    left: -15px;
    z-index: 2;
    background-image: radial-gradient(
      rgba(0, 0, 0, 0.459) 1px,
      transparent 1px
    );
    background-size: 10px 10px;
  }

  .circle.back {
    left: -30px;
    z-index: 1;
    background-image: radial-gradient(
      rgba(0, 0, 0, 0.459) 1px,
      transparent 1px
    );
    background-size: 10px 10px;
  }

  /* === PANEL DE DATOS === */
  .data {
    border-radius: 10px;
    padding: 20px;
    border: 1px solid var(--borderMario);
    background: var(--cardMario);
    box-shadow: 0 8px 30px var(--shadowMario);
  }

  .data-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 20px;
  }

  .data-grid div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 10px;
    border-bottom: 1px solid var(--borderMario);
    background: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    transition: background 0.2s ease;
  }

  .data-grid div:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .data-grid h3 {
    margin: 0;
    font-weight: 500;
    font-size: 0.95rem;
  }

  .data-grid label {
    font-weight: bold;
    font-size: 0.95rem;
  }

  /* === PANEL DE CONTROLES === */
  .panel {
    border-radius: 10px;
    padding: 20px;
    border: 1px solid var(--borderMario);
    background: var(--cardMario);
    box-shadow: 0 8px 30px var(--shadowMario);
  }

  .panel h2 {
    margin-top: 0;
    text-align: center;
    margin-bottom: 15px;
  }

  .panel label {
    font-weight: 500;
  }

  .panel-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }

  /* Estilo general de cada control */
  .panel-grid .control {
    display: flex;
    flex-direction: column;
    justify-content: end;
    padding: 2px 2px;
    border-radius: 6px;
    transition: background 0.2s ease;
  }

  /* Caso especial: el control del tipo de input (checkbox) */
  .panel-grid .control:first-child {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }

  .panel-grid .control:first-child label {
    margin-right: 10px;
    font-weight: 600;
  }

  .panel-grid .control:first-child input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--color-primary);
    cursor: pointer;
  }

  /* Resto de inputs */
  .panel-grid input[type="range"] {
    width: 100%;
    accent-color: var(--color-primary);
    margin-top: 6px;
  }

  .panel-grid input[type="number"] {
    width: 100%;
    margin-top: 6px;
    padding: 5px;
    border: 1px solid var(--borderMario);
    border-radius: 5px;
    background: rgba(0, 0, 0, 0.05);
  }

  /* === SOMBRAS Y BORDES === */
  .border {
    border: 1px solid var(--borderMario);
  }

  .rounded-md {
    border-radius: 10px;
  }

  .shadow {
    box-shadow: 0 8px 30px var(--shadowMario);
  }

  /* === ADAPTACI√ìN RESPONSIVA === */
  @media (max-width: 900px) {
    .layout {
      flex-direction: column;
    }

    .visual,
    .right-column {
      width: 100%;
    }

    .panel-grid {
      grid-template-columns: 1fr;
    }

    .data-grid {
      grid-template-columns: 1fr;
    }
  }

  body:not(.dark-mode) .panel label,
  body:not(.dark-mode) .panel h2,
  body:not(.dark-mode) .panel .control,
  body:not(.dark-mode) .data-grid h3,
  body:not(.dark-mode) .data-grid label {
    color: #000 !important;
  }
</style>
