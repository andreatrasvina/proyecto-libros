<section
  class="flex flex-col items-center justify-center p-6 border border-[var(--borderEjercicio)] 
  bg-[var(--cardEjercicio)] shadow-[var(--shadowEjercicio)] rounded-xl transition-colors duration-300"
>
  <h3 class="text-lg font-semibold text-[var(--titles)] mb-4 text-center">
    Ejercicio 6 – Flujo en un acuífero libre
  </h3>

  <div class="flex flex-wrap justify-center gap-3 mb-4">
    <button
      id="btnWater"
      class="px-4 py-2 rounded-lg font-medium bg-slate-200 text-slate-800 border border-slate-300 
             hover:bg-slate-300 hover:text-slate-900 shadow-sm transition-all duration-200"
    >
      Línea freática
    </button>

    <button
      id="btnEquip"
      class="px-4 py-2 rounded-lg font-medium bg-gray-100 text-gray-700 border border-gray-300 
             hover:bg-gray-200 hover:text-gray-900 shadow-sm transition-all duration-200"
    >
      Equipotencial (70–80 m)
    </button>

    <button
      id="btnFlow"
      class="px-4 py-2 rounded-lg font-medium bg-stone-200 text-stone-800 border border-stone-300 
             hover:bg-stone-300 hover:text-stone-900 shadow-sm transition-all duration-200"
    >
      Línea de flujo
    </button>

    <button
      id="btnClear"
      class="px-4 py-2 rounded-lg font-medium bg-neutral-100 text-neutral-600 border border-neutral-300 
             hover:bg-neutral-200 hover:text-neutral-800 shadow-sm transition-all duration-200"
    >
      Limpiar
    </button>
  </div>

  <div class="relative flex flex-col items-center">
    <canvas
      id="acuiferoCanvas"
      class="border border-gray-300 rounded-lg shadow-md cursor-crosshair bg-white"
    ></canvas>

    <p id="loadingText" class="text-gray-500 italic mt-2">Cargando imagen...</p>
    <p id="instructionText" class="text-sm text-gray-600 mt-2">Selecciona 3 puntos para crear una línea</p>
  </div>

  <div id="resultsBox" class="hidden mt-4 p-3 rounded-lg bg-slate-50 text-sm text-gray-800 border border-slate-200 max-w-md text-center"></div>

  <p class="mt-5 text-sm text-[var(--textoCardCanvas)] text-center leading-relaxed max-w-md">
    Selecciona 3 puntos para crear la <b>línea freática</b>, las <b>líneas equipotenciales (70 m, 75 m, 80 m)</b> 
    y las <b>líneas de flujo</b> sobre el esquema del acuífero libre.
  </p>
</section>

<script is:client>
  const canvas = document.getElementById("acuiferoCanvas");
  const ctx = canvas?.getContext("2d");
  const loadingText = document.getElementById("loadingText");
  const instructionText = document.getElementById("instructionText");
  const resultsBox = document.getElementById("resultsBox");

  const btnWater = document.getElementById("btnWater");
  const btnEquip = document.getElementById("btnEquip");
  const btnFlow = document.getElementById("btnFlow");
  const btnClear = document.getElementById("btnClear");

  let tool = "waterTable";
  let selectedPoints = [];
  let lines = [];
  let baseImg = new Image();
  let baseLoaded = false;

  // Coordenadas de los pozos (ajústalas si cambia el tamaño real)
  const WELL_A = { x: 120, y: 260, head: 80 };
  const WELL_B = { x: 580, y: 280, head: 70 };

  // --- ✅ Carga segura + ajuste real del canvas al tamaño de la imagen
  async function loadImageSafely() {
    const sources = [
      "/src/assets/image33-1.png",
      "https://books.gw-project.org/conceptual-and-visual-understanding-of-hydraulic-head-and-groundwater-flow/wp-content/uploads/sites/14/2020/12/image33-1.png",
      "https://corsproxy.io/?" + encodeURIComponent("https://books.gw-project.org/conceptual-and-visual-understanding-of-hydraulic-head-and-groundwater-flow/wp-content/uploads/sites/14/2020/12/image33-1.png")
    ];

    for (const src of sources) {
      try {
        await new Promise((resolve, reject) => {
          baseImg = new Image();
          baseImg.crossOrigin = "anonymous";
          baseImg.src = src;
          baseImg.onload = () => resolve();
          baseImg.onerror = reject;
        });

        baseLoaded = true;
        loadingText.style.display = "none";

        // ✅ Ajustar canvas al tamaño REAL de la imagen
        canvas.width = baseImg.width;
        canvas.height = baseImg.height;

        drawAll();
        return;
      } catch {
        console.warn("Falló cargar:", src);
      }
    }

    loadingText.textContent = "Error al cargar la imagen base.";
  }

  loadImageSafely();

  // --- Eventos del canvas
  canvas.addEventListener("click", (e) => {
    if (!baseLoaded) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    const point = { 
      x: (e.clientX - rect.left) * scaleX, 
      y: (e.clientY - rect.top) * scaleY 
    };

    if (point.x < WELL_A.x - 20 || point.x > WELL_B.x + 20) {
      instructionText.textContent = "Selecciona dentro del rango entre los pozos.";
      return;
    }

    selectedPoints.push(point);

    if (selectedPoints.length === 3) {
      lines.push({ type: tool, points: [...selectedPoints] });
      if (tool === "waterTable") calculateHydraulicData();
      selectedPoints = [];
    }

    updateInstruction();
    drawAll();
  });

  // Botones
  btnClear.addEventListener("click", () => {
    lines = [];
    selectedPoints = [];
    resultsBox.classList.add("hidden");
    drawAll();
  });

  btnWater.addEventListener("click", () => setTool("waterTable", btnWater));
  btnEquip.addEventListener("click", () => setTool("equipotential", btnEquip));
  btnFlow.addEventListener("click", () => setTool("flowLine", btnFlow));

  function setTool(newTool, activeButton) {
    tool = newTool;
    [btnWater, btnEquip, btnFlow].forEach((b) => {
      if (!b) return;
      b.classList.remove("bg-slate-400", "bg-gray-300", "bg-stone-300", "text-white");
    });
    activeButton.classList.add("bg-slate-400", "text-white");
  }

  // --- Dibujo principal
  function drawAll() {
    if (!ctx) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (baseLoaded) ctx.drawImage(baseImg, 0, 0); // ✅ sin escalado

    for (const l of lines) drawLine(l.points, l.type);
    for (let i = 0; i < selectedPoints.length; i++) drawPoint(selectedPoints[i], i);
    if (selectedPoints.length > 1) drawTempLine(selectedPoints);

    drawWell(WELL_A, "A");
    drawWell(WELL_B, "B");
  }

  function drawLine(points, type) {
    if (points.length < 2) return;

    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);

    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);

    ctx.strokeStyle =
      type === "waterTable" ? "#1E90FF" :
      type === "equipotential" ? "#FFD700" : "#00C853";

    ctx.lineWidth = 2.5;
    ctx.stroke();
  }

  function drawPoint(p, i) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
    ctx.fillStyle = "#dc2626";
    ctx.fill();
    ctx.font = "12px Arial";
    ctx.fillText(i + 1, p.x + 8, p.y - 8);
  }

  function drawTempLine(points) {
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);

    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);

    ctx.strokeStyle = "#9ca3af";
    ctx.setLineDash([4, 4]);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  function drawWell(well, label) {
    ctx.fillStyle = "#555";
    ctx.fillRect(well.x - 3, well.y - 60, 6, 60);
    ctx.fillStyle = "#0077b6";
    ctx.fillRect(well.x - 3, well.y - 10, 6, 10);
    ctx.font = "14px Arial";
    ctx.fillStyle = "#000";
    ctx.fillText(`${label} (${well.head} m)`, well.x - 20, well.y - 70);
  }

  function updateInstruction() {
    instructionText.textContent =
      selectedPoints.length === 0
        ? "Selecciona 3 puntos para crear una línea"
        : `Seleccionados: ${selectedPoints.length} / 3`;
  }

  // --- Cálculos del flujo subterráneo
  function calculateHydraulicData() {
    const deltaH = WELL_A.head - WELL_B.head;
    const dx = (WELL_B.x - WELL_A.x) * 0.1;
    const i = deltaH / dx;
    const K = 1e-4;
    const A = 40;
    const Q = K * i * A;

    resultsBox.classList.remove("hidden");
    resultsBox.innerHTML = `
      <b>Resultados del cálculo:</b><br/>
      Diferencia de cabeza (Δh): ${deltaH.toFixed(2)} m<br/>
      Distancia horizontal (L): ${dx.toFixed(2)} m<br/>
      Gradiente hidráulico (i): ${i.toFixed(4)}<br/>
      Conductividad hidráulica (K): ${K.toExponential(2)} m/s<br/>
      Caudal estimado (Q): ${Q.toExponential(3)} m³/s<br/>
      Dirección del flujo: del Pozo A → Pozo B
    `;
  }

  setTool("waterTable", btnWater);
</script>
