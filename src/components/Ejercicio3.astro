---
import "../styles/global.css";
---

<section
  class="flex flex-col items-center justify-center p-6 border border-[var(--borderEjercicio)] 
  bg-[var(--cardEjercicio)] shadow-[var(--shadowEjercicio)] rounded-xl transition-colors duration-300"
>
  <h3 class="text-lg font-semibold text-[var(--titles)] mb-4 text-center">
    Interactive Hydraulic Head with Sand Divisions
  </h3>

  <!-- üíß Contenedor visual RESPONSIVO -->
  <div class="relative w-[85vw] max-w-[450px] aspect-[4/5] flex flex-col items-center">
    <!-- Imagen base -->
    <img
      src="/images/exercise3-base.png"
      alt="Hydraulic head diagram"
      class="absolute inset-0 w-full h-full object-contain rounded-md border border-[var(--borderEjercicio)]"
    />

    <!-- Base horizontal -->
    <div
      id="waterBase"
      class="absolute left-[40%] bottom-[9.8%] w-[40%] bg-[#55CFFF]"
      style="height:10%;"
    ></div>

    <!-- Tubo derecho -->
    <div
      id="waterRight"
      class="absolute left-[80%] bottom-[9.8%] w-[5.5%] bg-[#55CFFF]"
      style="height:55%;"
    ></div>

    <!-- Tubo izquierdo -->
    <div
      id="waterLeft"
      class="absolute left-[30%] bottom-[9.8%] w-[10.5%] bg-[#55CFFF]"
      style="height:68%;"
    ></div>

    <!-- Zona de arena -->
    <div
      id="sandZone"
      class="absolute left-[30%] bottom-[20.5%] w-[10.5%] h-[30%] pointer-events-none overflow-hidden"
    ></div>
  </div>

  <!-- üîò Checkbox modo manual -->
  <div class="flex items-center justify-center gap-2 my-6 mt-15">
    <input
      id="manualToggle"
      type="checkbox"
      class="w-4 h-4 accent-[var(--titles)] cursor-pointer"
    />
    <label
      for="manualToggle"
      class="text-[var(--textoCardCanvas)] cursor-pointer select-none"
    >
      Enable manual input mode
    </label>
  </div>

  <!-- üéõÔ∏è Controles -->
  <div class="mt-2 flex flex-col items-center gap-6">
    <div class="flex flex-col items-center">
      <label for="waterInput" class="text-sm text-[var(--titles)] mb-2">
        Select water level (ft):
        <span id="waterValue" class="font-semibold ml-1">12</span>
      </label>
      <div id="waterContainer" class="flex justify-center"></div>
    </div>

    <div class="flex flex-col items-center">
      <label for="sandInput" class="text-sm text-[var(--titles)] mb-2">
        Sand divisions added:
        <span id="sandValue" class="font-semibold ml-1">0</span>
      </label>
      <div id="sandContainer" class="flex justify-center"></div>
    </div>

    <p id="warningMsg" class="text-xs text-[var(--titles)] mt-2 h-4"></p>
  </div>

  <p class="mt-5 text-sm text-[var(--textoCardCanvas)] text-center leading-relaxed max-w-md">
    Default head on the right (h‚ÇÇ) = 12 ft.  
    Adding sand divisions increases the left head (h‚ÇÅ) by 1 ft per division.  
    Divisions appear only inside the sand zone.  
    Water level can be adjusted between 0 and 12 ft using either input type.
  </p>
</section>

<script is:client>
  const manualToggle = document.getElementById("manualToggle");

  const waterContainer = document.getElementById("waterContainer");
  const sandContainer = document.getElementById("sandContainer");
  const waterValue = document.getElementById("waterValue");
  const sandValue = document.getElementById("sandValue");

  const waterBase = document.getElementById("waterBase");
  const waterRight = document.getElementById("waterRight");
  const waterLeft = document.getElementById("waterLeft");
  const sandZone = document.getElementById("sandZone");

  let currentWater = 12;
  let currentSand = 4;

  const createInput = (manual) => {
    waterContainer.innerHTML = "";
    sandContainer.innerHTML = "";

    const waterInput = document.createElement("input");
    waterInput.id = "waterInput";
    waterInput.type = manual ? "number" : "range";
    waterInput.min = 0;
    waterInput.max = 12;
    waterInput.step = 1;
    waterInput.value = currentWater;
    waterInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--rayaTubo)] cursor-pointer";
    waterInput.addEventListener("input", (e) => {
      currentWater = parseFloat(e.target.value);
      updateVisuals();
    });
    waterContainer.appendChild(waterInput);

    const sandInput = document.createElement("input");
    sandInput.id = "sandInput";
    sandInput.type = manual ? "number" : "range";
    sandInput.min = 0;
    sandInput.max = 4;
    sandInput.step = 1;
    sandInput.value = currentSand;
    sandInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--titles)] cursor-pointer";
    sandInput.addEventListener("input", (e) => {
      currentSand = parseInt(e.target.value);
      updateVisuals();
    });
    sandContainer.appendChild(sandInput);
  };

  const drawSandDivisions = () => {
    sandZone.innerHTML = "";
    if (currentSand === 0) return;

    // üîπ Referencia com√∫n: el contenedor principal (mismo que usa el agua)
    const container = sandZone.offsetParent || sandZone.parentElement;
    const totalContainerHeight = container.clientHeight || 100;

    // Escala base (59% = 16 ft)
    const tuboIzqMaxPercent = 59;
    const tuboIzqMaxFt = 16;
    const percentPerFt = tuboIzqMaxPercent / tuboIzqMaxFt; // 3.6875% por ft

    // Cu√°ntos px son 1 ft en la escala general
    const pxPorFt = (totalContainerHeight * percentPerFt) / 100;

    // üî∏ Ahora dibujar dentro del sandZone, pero usando la escala global
    for (let i = 0; i < currentSand; i++) {
      const line = document.createElement("div");
      line.style.position = "absolute";
      line.style.left = "0";
      line.style.width = "100%";
      line.style.height = `${Math.max(2, Math.round(pxPorFt) - 1)}px`;
      line.style.bottom = `${Math.round(i * pxPorFt)}px`;

      // Estilo igual al original
      line.style.background = `
        radial-gradient(circle at 3px 3px, rgba(0,0,0,0.9) 0.6px, transparent 1px),
        radial-gradient(circle at 7px 7px, rgba(0,0,0,0.9) 0.6px, transparent 1px),
        #BEF7FE
      `;
      line.style.backgroundSize = "8px 8px";
      line.style.borderTop = "1px solid rgba(0,0,0,0.25)";
      line.style.boxSizing = "border-box";

      sandZone.appendChild(line);
    }
  };


  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  // ‚úÖ NUEVA FUNCI√ìN ADAPTADA A PORCENTAJES
  // ‚úÖ FUNCI√ìN FINAL ACTUALIZADA ‚Äî escala 59% = 16 ft y regla de no subir agua si h‚ÇÇ ‚â§ 3 ft
  // ‚úÖ FUNCI√ìN FINAL CON ESCALA, CONDICI√ìN Y ANIMACI√ìN SUAVE
  const updateVisuals = () => {
    const h2 = clamp(currentWater, 0, 12);
    const divisions = clamp(currentSand, 0, 4);
    waterValue.textContent = h2;
    sandValue.textContent = divisions;

    // üîπ Configuraci√≥n de escalas y l√≠mites
    const canalMaxPercent = 9;      // base horizontal (visual)
    const tuboDerMaxPercent = 16;   // tubo derecho visual (12 ft)
    const tuboIzqMaxPercent = 59;   // tubo izquierdo visual (16 ft)
    const tuboIzqMaxFt = 16;
    const percentPerFt = tuboIzqMaxPercent / tuboIzqMaxFt; // 59/16 = 3.6875 % por ft

    const canalMaxFt = 2.4;
    const tuboDerMaxFt = 12;
    const tuboIzqMaxFtConst = 16;

    // üîπ Alturas proporcionales
    const baseHeightPercent = Math.min(h2 * percentPerFt, canalMaxFt * percentPerFt);
    const rightHeightPercent = Math.min(h2 * percentPerFt, tuboDerMaxFt * percentPerFt);

    // üîπ Condici√≥n: el tubo izquierdo no sube si h‚ÇÇ ‚â§ 3 ft
    let leftFt = h2;
    if (h2 > 3) {
      leftFt += divisions;
    }

    const leftHeightPercent = Math.min(leftFt * percentPerFt, tuboIzqMaxFtConst * percentPerFt);

    // üíß Aplicar alturas con animaci√≥n
    [waterBase, waterRight, waterLeft].forEach(el => {
      el.style.transition = "height 0.8s cubic-bezier(0.45, 0, 0.55, 1)";
    });

    waterBase.style.height = `${baseHeightPercent}%`;
    waterRight.style.height = `${rightHeightPercent}%`;
    waterLeft.style.height = `${leftHeightPercent}%`;

    // üîπ Redibujar divisiones de arena
    drawSandDivisions();

    // üîπ Control de inputs y mensajes
    const waterInput = document.getElementById("waterInput");
    const sandInput = document.getElementById("sandInput");
    const warningMsg = document.getElementById("warningMsg");

    if (h2 <= 0) {
      sandInput.disabled = true;
      sandInput.classList.add("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "‚ö†Ô∏è No puedes agregar arena sin agua presente.";
    } else if (divisions > 0 ) {
      waterInput.disabled = true;
      waterInput.classList.add("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "‚ö†Ô∏è Vac√≠a la arena antes de ajustar el nivel de agua.";
    } else {
      waterInput.disabled = false;
      sandInput.disabled = false;
      waterInput.classList.remove("opacity-50", "cursor-not-allowed");
      sandInput.classList.remove("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "";
    }
  };

  // ‚úÖ Inicializaci√≥n
  manualToggle.addEventListener("change", (e) => {
    createInput(e.target.checked);
    updateVisuals();
  });

  // Aplicar transici√≥n inicial a los niveles de agua
  [waterBase, waterRight, waterLeft].forEach(el => {
    el.style.transition = "height 0.8s cubic-bezier(0.45, 0, 0.55, 1)";
  });

  createInput(false);
  updateVisuals();
  manualToggle.checked = false;

</script>
