---
import "../styles/global.css";
---

<section
  class="flex flex-col items-center justify-center p-6 border border-[var(--borderEjercicio)] 
  bg-[var(--cardEjercicio)] shadow-[var(--shadowEjercicio)] rounded-xl transition-colors duration-300"
>
  <h3 class="text-lg font-semibold text-[var(--titles)] mb-4 text-center">
    Interactive Hydraulic Head with Sand Divisions
  </h3>

  <!-- üíß Contenedor visual -->
  <div class="relative flex flex-col items-center">
    <img
      src="/images/exercise3-base.png"
      alt="Hydraulic head diagram"
      class="max-w-sm rounded-md border border-[var(--borderEjercicio)]"
    />

    <!-- Canal horizontal -->
    <div
      id="waterMiddle"
      class="absolute bottom-[2.9rem] left-[7.8rem] w-[12.6rem] bg-[#55CFFF] opacity-100
      transition-all duration-300 ease-out"
      style="height:100px;"
    ></div>

    <!-- Tubo derecho (h‚ÇÇ = constante base 12 ft) -->
    <div
      id="waterRight"
      class="absolute bottom-[2.9rem] left-[19.15rem] w-[1.3rem] bg-[#55CFFF] opacity-100
      transition-all duration-300 ease-out"
      style="height:202px;"
    ></div>

    <!-- Tubo izquierdo (h‚ÇÅ depende de arena) -->
    <div
      id="waterLeft"
      class="absolute bottom-[2.9rem] left-[7.2rem] w-[2.45rem] bg-[#55CFFF] opacity-100
      transition-all duration-300 ease-out"
      style="height:270px;"
    ></div>

    <!-- Zona de arena -->
    <div
      id="sandZone"
      class="absolute bottom-[6.2rem] left-[7.2rem] w-[2.45rem] h-[170px] bg-transparent pointer-events-none overflow-hidden"
    ></div>

  </div>

  <!-- üîò Checkbox modo manual -->
  <div class="flex items-center justify-center gap-2 my-6">
    <input
      id="manualToggle"
      type="checkbox"
      class="w-4 h-4 accent-[var(--titles)] cursor-pointer"
    />
    <label
      for="manualToggle"
      class="text-[var(--textoCardCanvas)] cursor-pointer select-none"
    >
      Enable manual input mode
    </label>
  </div>

  <!-- üéõÔ∏è Controles -->
  <div class="mt-2 flex flex-col items-center gap-6">
    <!-- Control nivel de agua -->
    <div class="flex flex-col items-center">
      <label for="waterInput" class="text-sm text-[var(--titles)] mb-2">
        Select water level (ft):
        <span id="waterValue" class="font-semibold ml-1">12</span>
      </label>
      <div id="waterContainer" class="flex justify-center"></div>
    </div>

    <!-- Control divisiones de arena -->
    <div class="flex flex-col items-center">
      <label for="sandInput" class="text-sm text-[var(--titles)] mb-2">
        Sand divisions added:
        <span id="sandValue" class="font-semibold ml-1">0</span>
      </label>
      <div id="sandContainer" class="flex justify-center"></div>
    </div>
  </div>

  <p class="mt-5 text-sm text-[var(--textoCardCanvas)] text-center leading-relaxed max-w-md">
    Default head on the right (h‚ÇÇ) = 12 ft.  
    Adding sand divisions increases the left head (h‚ÇÅ) by 1 ft per division.  
    Divisions appear only inside the sand zone.  
    Water level can be adjusted between 0 and 12 ft using either input type.
  </p>
</section>

<!-- üß† Script -->
<script is:client>
  const manualToggle = document.getElementById("manualToggle");

  const waterContainer = document.getElementById("waterContainer");
  const sandContainer = document.getElementById("sandContainer");
  const waterValue = document.getElementById("waterValue");
  const sandValue = document.getElementById("sandValue");

  const waterMiddle = document.getElementById("waterMiddle");
  const waterRight = document.getElementById("waterRight");
  const waterLeft = document.getElementById("waterLeft");
  const sandZone = document.getElementById("sandZone");


  let waterLevel = 12; // h‚ÇÇ
  let sandDivisions = 0;
  let currentWater = 0;
  let currentSand = 4;

  // üß© Crear input din√°mico
  const createInput = (manual) => {
    waterContainer.innerHTML = "";
    sandContainer.innerHTML = "";

    // Nivel de agua
    const waterInput = document.createElement("input");
    waterInput.id = "waterInput";
    waterInput.type = manual ? "number" : "range";
    waterInput.min = 0;
    waterInput.max = 12;
    waterInput.step = 1;
    waterInput.value = currentWater;
    waterInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--rayaTubo)] cursor-pointer";
    waterInput.addEventListener("input", (e) => {
      currentWater = parseFloat(e.target.value);
      updateVisuals();
    });
    waterContainer.appendChild(waterInput);

    // Divisiones de arena
    const sandInput = document.createElement("input");
    sandInput.id = "sandInput";
    sandInput.type = manual ? "number" : "range";
    sandInput.min = 0;
    sandInput.max = 4;
    sandInput.step = 1;
    sandInput.value = currentSand;
    sandInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--titles)] cursor-pointer";
    sandInput.addEventListener("input", (e) => {
      currentSand = parseInt(e.target.value);
      updateVisuals();
    });
    sandContainer.appendChild(sandInput);
  };

  // üèóÔ∏è Dibujar divisiones de arena
  const drawSandDivisions = () => {
    sandZone.innerHTML = "";

    if (currentSand === 0) return;

    const totalHeight = 100; // altura fija del √°rea de arena
    const divisionHeight = totalHeight / 4;

    for (let i = 0; i < currentSand; i++) {
      const block = document.createElement("div");
      block.style.position = "absolute";
      block.style.left = "0";
      block.style.width = "100%";
      block.style.height = `${divisionHeight}px`;
      block.style.bottom = `${i * divisionHeight}px`;
      block.style.background = "rgba(168, 230, 255, 0.4)";
      block.style.borderTop = "1px solid black";
      block.style.borderBottom = "1px solid black";
      sandZone.appendChild(block);
    }
  };

  // üíß Actualizar visualizaci√≥n
  // üíß Actualizar visualizaci√≥n
  const updateVisuals = () => {
    waterLevel = currentWater;
    sandDivisions = currentSand;

    const h1 = Math.min(12 + sandDivisions, 16);

    waterValue.textContent = waterLevel;
    sandValue.textContent = sandDivisions;

    // Escalas reales
    const canalMax = 60;     // altura visual del canal (0‚Äì6 ft)
    const tuboMax = 202;     // tubo derecho (0‚Äì12 ft)
    const tuboIzqMax = 270;  // tubo izquierdo (0‚Äì16 ft con arena)

    let canalHeight = 0;
    let rightHeight = 0;
    let leftHeight = 0;

    if (waterLevel <= 6) {
      // üü¶ Fase 1: sube parejo en todo el sistema
      const ratio = waterLevel / 6; // 0‚Äì1
      const sharedHeight = ratio * canalMax; // misma escala para todos
      canalHeight = sharedHeight;
      rightHeight = sharedHeight;
      leftHeight = sharedHeight;
    } else {
      // üü¶ Fase 2: canal lleno, suben solo los tubos
      canalHeight = canalMax;
      const ratio = (waterLevel - 6) / 6; // 0‚Äì1 de 6‚Üí12
      rightHeight = canalMax + ratio * (tuboMax - canalMax);
      leftHeight = canalMax + ratio * (tuboIzqMax - canalMax);
    }

    // üîπ Ajuste por arena (solo tubo izquierdo)
    const leftScale = h1 / 16;
    leftHeight *= leftScale;

    // Aplicar alturas visuales
    waterMiddle.style.height = canalHeight + "px";
    waterRight.style.height = rightHeight + "px";
    waterLeft.style.height = leftHeight + "px";

    drawSandDivisions();
  };




  // üîò Evento modo manual
  manualToggle.addEventListener("change", (e) => {
    createInput(e.target.checked);
  });

  // üöÄ Inicializaci√≥n
  createInput(false);
  updateVisuals();
</script>
