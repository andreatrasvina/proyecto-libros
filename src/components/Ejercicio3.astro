---
import "../styles/global.css";
---

<section
  class="flex flex-col items-center justify-center p-6 border border-[var(--borderEjercicio)] 
  bg-[var(--cardEjercicio)] shadow-[var(--shadowEjercicio)] rounded-xl transition-colors duration-300"
>
  <h3 class="text-lg font-semibold text-[var(--titles)] mb-4 text-center">
    Interactive Hydraulic Head with Sand Divisions
  </h3>

  <!-- üíß Contenedor visual -->
  <div class="relative flex flex-col items-center">
    <img
      src="/images/exercise3-base.png"
      alt="Hydraulic head diagram"
      class="max-w-sm rounded-md border border-[var(--borderEjercicio)]"
    />

    <!-- Base horizontal -->
    <div
      id="waterBase"
      class="absolute bottom-[2.91rem] left-[7.2rem] w-[13.35rem] bg-[#55CFFF] opacity-100
      transition-[height] duration-0 ease-linear will-change-[height]"

      style="height:40px;"
    ></div>

    <!-- Tubo derecho -->
    <div
      id="waterRight"
      class="absolute bottom-[5.55rem] left-[19.2rem] w-[1.35rem] bg-[#55CFFF] opacity-100
      transition-[height] duration-0 ease-linear will-change-[height]"
      style="height:212px;"
    ></div>

    <!-- Tubo izquierdo -->
    <div
      id="waterLeft"
      class="absolute bottom-[5.55rem] left-[7.21rem] w-[2.48rem] bg-[#55CFFF] opacity-100
      transition-[height] duration-0 ease-linear will-change-[height]"
      style="height:270px;"
    ></div>

    <!-- Zona de arena -->
    <div
      id="sandZone"
      class="absolute bottom-[6.16rem] left-[7.23rem] w-[2.4rem] h-[115px] pointer-events-none overflow-hidden"
    ></div>
  </div>

  <!-- üîò Checkbox modo manual -->
  <div class="flex items-center justify-center gap-2 my-6">
    <input
      id="manualToggle"
      type="checkbox"
      class="w-4 h-4 accent-[var(--titles)] cursor-pointer"
    />
    <label
      for="manualToggle"
      class="text-[var(--textoCardCanvas)] cursor-pointer select-none"
    >
      Enable manual input mode
    </label>
  </div>

  <!-- üéõÔ∏è Controles -->
  <div class="mt-2 flex flex-col items-center gap-6">
    <div class="flex flex-col items-center">
      <label for="waterInput" class="text-sm text-[var(--titles)] mb-2">
        Select water level (ft):
        <span id="waterValue" class="font-semibold ml-1">12</span>
      </label>
      <div id="waterContainer" class="flex justify-center"></div>
    </div>

    <div class="flex flex-col items-center">
      <label for="sandInput" class="text-sm text-[var(--titles)] mb-2">
        Sand divisions added:
        <span id="sandValue" class="font-semibold ml-1">0</span>
      </label>
      <div id="sandContainer" class="flex justify-center"></div>
    </div>

    <p id="warningMsg" class="text-xs text-[var(--titles)] mt-2 h-4"></p>
  </div>

  <p class="mt-5 text-sm text-[var(--textoCardCanvas)] text-center leading-relaxed max-w-md">
    Default head on the right (h‚ÇÇ) = 12 ft.  
    Adding sand divisions increases the left head (h‚ÇÅ) by 1 ft per division.  
    Divisions appear only inside the sand zone.  
    Water level can be adjusted between 0 and 12 ft using either input type.
  </p>
</section>

<script is:client>
  const manualToggle = document.getElementById("manualToggle");

  const waterContainer = document.getElementById("waterContainer");
  const sandContainer = document.getElementById("sandContainer");
  const waterValue = document.getElementById("waterValue");
  const sandValue = document.getElementById("sandValue");

  const waterBase = document.getElementById("waterBase");
  const waterRight = document.getElementById("waterRight");
  const waterLeft = document.getElementById("waterLeft");
  const sandZone = document.getElementById("sandZone");

  let currentWater = 12;
  let currentSand = 4;

  const createInput = (manual) => {
    waterContainer.innerHTML = "";
    sandContainer.innerHTML = "";

    const waterInput = document.createElement("input");
    waterInput.id = "waterInput";
    waterInput.type = manual ? "number" : "range";
    waterInput.min = 0;
    waterInput.max = 12;
    waterInput.step = 1;
    waterInput.value = currentWater;
    waterInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--rayaTubo)] cursor-pointer";
    waterInput.addEventListener("input", (e) => {
      currentWater = parseFloat(e.target.value);
      updateVisuals();
    });
    waterContainer.appendChild(waterInput);

    const sandInput = document.createElement("input");
    sandInput.id = "sandInput";
    sandInput.type = manual ? "number" : "range";
    sandInput.min = 0;
    sandInput.max = 4;
    sandInput.step = 1;
    sandInput.value = currentSand;
    sandInput.className = manual
      ? "w-24 text-center border border-[var(--borderEjercicio)] rounded-md bg-[var(--cards)] text-[var(--titles)]"
      : "w-64 accent-[var(--titles)] cursor-pointer";
    sandInput.addEventListener("input", (e) => {
      currentSand = parseInt(e.target.value);
      updateVisuals();
    });
    sandContainer.appendChild(sandInput);
  };

  const drawSandDivisions = () => {
    sandZone.innerHTML = "";
    if (currentSand === 0) return;
    const totalHeight = sandZone.clientHeight || 115;
    const divisionHeight = totalHeight / 4;
    for (let i = 0; i < currentSand; i++) {
      const line = document.createElement("div");
      line.style.position = "absolute";
      line.style.left = "0";
      line.style.width = "100%";
      line.style.height = `${divisionHeight - 1}px`;
      line.style.bottom = `${i * divisionHeight}px`;
      line.style.background = `
        radial-gradient(circle at 3px 3px, rgba(0,0,0,1) 0.5px, transparent 1px),
        radial-gradient(circle at 7px 7px, rgba(0,0,0,1) 0.5px, transparent 1px),
        #BEF7FE
      `;
      line.style.backgroundSize = "8px 8px";
      sandZone.appendChild(line);
    }
  };

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  const updateVisuals = () => {
    const h2 = clamp(currentWater, 0, 12);
    const divisions = clamp(currentSand, 0, 4);
    waterValue.textContent = h2;
    sandValue.textContent = divisions;

    const canalMax = 53;   // altura total del canal (0‚Äì6 ft)
    const tuboMax = 265;   // tubo derecho 0‚Äì12 ft
    const tuboIzqMax = 355; // tubo izquierdo 0‚Äì16 ft

    if (h2 <= 0) {
      waterBase.style.height = "0px";
      waterRight.style.height = "0px";
      waterLeft.style.height = "0px";
      drawSandDivisions();
    } else {
      // base canal
      const baseHeight = h2 <= 6 ? (h2 / 6) * canalMax : canalMax;

      // tubo derecho ‚Üí inicia a los 6 ft
      let rightHeight = 0;
      if (h2 > 6) {
        const ratio = (h2 - 6) / 6;
        rightHeight = ratio * (tuboMax - canalMax);
      }

      // tubo izquierdo ‚Üí igual + efecto de arena
      let leftHeight = rightHeight;
      if (divisions > 0 && h2 > 6) {
        const proportionalFactor = h2 / 12;
        const extraFt = divisions * proportionalFactor;
        const pxPerFtLeft = (tuboIzqMax - tuboMax) / 4;
        leftHeight += extraFt * pxPerFtLeft;
      }

      waterBase.style.height = `${Math.max(0, Math.min(baseHeight, canalMax))}px`;
      waterRight.style.height = `${Math.max(0, Math.min(rightHeight, tuboMax - canalMax))}px`;
      waterLeft.style.height = `${Math.max(0, Math.min(leftHeight, tuboIzqMax - canalMax))}px`;

      drawSandDivisions();
    }

    // bloqueos
    const waterInput = document.getElementById("waterInput");
    const sandInput = document.getElementById("sandInput");
    const warningMsg = document.getElementById("warningMsg");

    if (h2 <= 0) {
      sandInput.disabled = true;
      sandInput.classList.add("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "‚ö†Ô∏è No puedes agregar arena sin agua presente.";
    } else if (divisions > 0) {
      waterInput.disabled = true;
      waterInput.classList.add("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "‚ö†Ô∏è Vac√≠a la arena antes de ajustar el nivel de agua.";
    } else {
      waterInput.disabled = false;
      sandInput.disabled = false;
      waterInput.classList.remove("opacity-50", "cursor-not-allowed");
      sandInput.classList.remove("opacity-50", "cursor-not-allowed");
      warningMsg.textContent = "";
    }
  };

  manualToggle.addEventListener("change", (e) => createInput(e.target.checked));

  createInput(false);
  updateVisuals();
  // üßº Reiniciar el estado del checkbox al cargar la p√°gina
  manualToggle.checked = false;

</script>
